<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Trusted Party Live Session Tracker</title>

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"
          integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"
          integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"
          integrity="sha256-PieqE0QdEDMppwXrTzSZQr6tWFX3W5KkyRVyF1zN3eg=" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/Ladda/1.0.0/ladda.min.js"
          integrity="sha256-/DTavTzjSAI87+voZGCTfhbioWGET1qDJKe76XuWQ5M=" crossorigin="anonymous"></script>

  <script src="scripts/session.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/Ladda/1.0.0/ladda-themeless.min.css"
        integrity="sha256-d7VZTlP9P3ZTCZ3Bkl8aGZ/+Vs4i+bpcOGNfibU7+LU=" crossorigin="anonymous"/>

  <link rel="stylesheet" href="styles/style.css">

</head>
<html>
<body>
<header>
  <div class="container">
    <h1>Trusted Party<br/>
      <small>Live Session Tracker</small>
    </h1>
    <div id="logos">
      <img src="images/bwwc.png" width="130" alt="BWWC Logo"/>
      <img src="images/bu.gif" alt="BU Logo"/>
    </div>
  </div>
</header>
<div id="shadow" class="ss-style-multitriangles"></div>
<main id="content" class="container">
</main>
<div class="container">
  <form class="form-inline" role="form" id="inputform">
    <input type="text" id="sess" placeholder="Session Number"/>
    <input type="password" id="pass" placeholder="Session Password"/>
    <button id="submit" type="button" class="btn btn-primary" onclick="genT()">SUBMIT</button>
  </form>

  <div class="hidden">
    <div class="alert alert-success" id="statusID">LOADING...</div>
    <div>
      <h3>Control Panel</h3>
      <input id="statusbox" type="text" placeholder="Session Status:" disabled><br>
      <input type="button" class="btn btn-primary" id="start" value="START">
      <input type="button" class="btn btn-primary" id="pause" value="PAUSE">
      <input type="button" class="btn btn-primary" id="stop" value="STOP">
    </div>

    <div id="confirmation" class="modal">
      <h3>Please confirm Session termination</h3>
      <form class="form-inline" role="form" id="confirmationform">
        <input type="text" id="sess_s" placeholder="Session Number"/> <br/>
        <input type="password" id="pass_s" placeholder="Session Password"/> <br/>
        <button id="confirm" type="button" class="btn btn-primary">SUBMIT</button>
        <button id="cancel" type="button" class="btn btn-primary">CANCEL</button>
        <br/>
        <h4 id="modal_error_msg"></h4>
      </form>
    </div>

    <h3>Tracking and Unmasking</h3>
    <div><a id="unmasklink"></a></div>
    <table class="table table-striped" id="table">
      <thead>
      <tr>
        <th>Email</th>
        <th>Posted</th>
      </tr>
      </thead>
      <tbody id="participants">
      </tbody>
    </table>
    <br/>
    <div id="urlsSection">
      <h3>Links for Participants </h3>
      <form class="form-inline" role="form">
        <input autocomplete="off" type="text" id="countID" placeholder="Enter Number of new links needed"
               pattern="^[0-9]{1,5}$" size="5" required>
        <button id="gen_button" type="button" class="btn">
          Generate Links
        </button>
      </form>
      <pre id="urlsID"></pre>

      <div id="oldUrlsSection">
        <h3>Previously Generated Links</h3>
        <pre id="oldUrlsID"></pre>
      </div>
    </div>
  </div>
  <script>
    window.getParameterByName = function (name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    };
    if (getParameterByName('session')) {
      var session = getParameterByName('session');
      document.getElementById("sess").value = session;
    }
    window.genT = function () {
      document.getElementsByClassName('hidden').style.visibility = "visible";

      var session = document.getElementById('sess').value;
      var password = document.getElementById('pass').value;
      var start = document.getElementById('start').value;
      var pause = document.getElementById('pause').value;
      var stop = document.getElementById('stop').value;
      $('#inputform').remove();

      document.getElementById('unmasklink').innerHTML = "Click here to unmask aggregate data Session " + session;
      document.getElementById('unmasklink').href = "../unmask/index.html?session=" + session;

      checkStatus(session);
      generateTable('table', session, password, 'statusID');

      fetchOldLinks(session, password, "oldUrlsID", "oldUrlsSection");
      document.getElementById("gen_button").onclick = function () {
        var count = document.getElementById("countID").value;
        count = parseInt(count);

        if(isNaN(count)) { // fail gracefully
          alert("Please enter the number of desired links");
          return;
        }

        generateUrls(session, password, 'urlsID', count);
      };

      document.getElementById("start").onclick = function () {
        changeStatus(session, start, password)
      };
      document.getElementById("pause").onclick = function () {
        changeStatus(session, pause, password)
      };
      document.getElementById("stop").onclick = function () {
        document.getElementById('statusbox').value = checkStatus(session);
        document.getElementById('modal_error_msg').innerHTML = "";
        document.getElementById('confirmation').style.visibility = "visible";

        document.getElementById("cancel").onclick = function () {
          document.getElementById('confirmation').style.visibility = "hidden";
        };

        document.getElementById("confirm").onclick = function () {
          var modal_session = document.getElementById('sess_s').value;
          var modal_password = document.getElementById('pass_s').value;
          if (modal_session === session && modal_password === password) {
            document.getElementById('confirmation').style.visibility = "hidden";
            changeStatus(session, stop, password);
          } else {
            document.getElementById('modal_error_msg').innerHTML = "Session and Password do not match!";
          }
        };
      };
    };

    window.getParameterByName = function (name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    };

    if (getParameterByName('session')) {
      var session = getParameterByName('session');
      document.getElementById("sess").value = session;
    }
  </script>
</div>
</body>
</html>
