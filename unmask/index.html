<!doctype html>
<html>
<head>
	<title>Trusted Party Data Unmasker</title>

    <script type="text/javascript" src="../shared/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="../shared/underscore.js"></script>
    <script type="text/javascript" src="../shared/aggregate.js"></script>
    <script type="text/javascript" src="../shared/handsontable-pro/dist/handsontable.full.js"></script>
    <script type="text/javascript" src="style/bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="script/spin.min.js"></script>
    <script type="text/javascript" src="script/ladda.min.js"></script>
    <script type="text/javascript" src="script/unmask.js"></script>
    
    <link rel="stylesheet" type="text/css" href="../shared/handsontable-pro/dist/handsontable.full.css">
    <link rel="stylesheet" type="text/css" href="style/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="style/ladda-themeless.min.css">
    <style type="text/css">
      .handsontable .ht_clone_top,
      .handsontable .ht_clone_top_left,
      .handsontable .ht_clone_top_left_corner {
        transform: initial !important;
      }
      #main-hot .handsontable col.rowHeader {
        width: 200px !important;
      }
      .handsontable th:first-child {
        text-align: left;
        white-space: normal;
      }
      .handsontable th {
        font-size:12px;
        white-space: pre-line;
        max-width: 110px;
        vertical-align: middle;
      }
      pre {
        text-align:left;
      }
      pre p {
        font-size:12px;
      }
    </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <table width="100%">
        <tr>
          <td>
            <h1>Trusted Party<br/><small>Aggregate Data Unmasker</small></h1>
          </td>
          <td align="right">
            <img src="../shared/bu.png" width="110px"/>
          </td>
        </tr>
      </table>
    </div>

    <h4>Input Session Key</h4>
    <input type=text id="sessKey" placeholder="Session Key"/>

    <h4>Upload Private Key  <small>(Note this does not upload the key to the network)</small></h4>
    <input type=file id="maskKey"/>

    <br/>
    <br/>

    <button id="unmask" class="btn btn-primary ladda-button" data-style="zoom-out">
      <span class="ladda-label">Unmask Data</span>
    </button>

    <br/><br/>
    <div id="friendly">
      <div id="main-hot"></div>
      <br/>
      <div id="board-hot"></div>
      <br/>
      <pre id="board-include"></pre>
      <br/>
      <pre id="question"></pre>
    </div>
    <br/>
    <pre id="result"></pre>
    <pre id="error"></pre>
    <script type="text/javascript">
      // This is the handsontable object which will be defined
      // during the unmasking process.
      var mainHot = {table: null},
          boardHot = {table: null};

      $('pre').hide();
      $('#main-hot').hide();
      $('#board-hot').hide();

      $('#unmask').on('click', function() {
        $('pre').hide();
        $('#main-hot').hide();
        $('#board-hot').hide();
        
        var maskKey = $('#maskKey').get(0),
            sessKey = $('#sessKey').val(),
            la = Ladda.create(this),
            keyReader = new FileReader();

        if (maskKey.files.length) {
          la.start();
          keyReader.readAsText(maskKey.files[0]);
          $(keyReader).on('load', function(e) {
            var privateKey = e.target.result,
                callb =
                  function (success, data) {
                    la.stop();
                    if (success) {
                      var sections = unflatten(data);
                      for (var sectionName in sections) {
                        if (sections.hasOwnProperty(sectionName)) {
                          var section = sections[sectionName];
                          if (sectionName === 'main') {
                            displayFromTemplate(
                              "#main-hot", 
                              mainHot, 
                              section, 
                              "../shared/templates/main.json"
                            );
                          }
                          else if (sectionName === 'board') {
                            displayFromTemplate(
                              "#board-hot", 
                              boardHot, 
                              section, 
                              "../shared/templates/board.json"
                            );
                          }
                          else if (sectionName === 'includeBoard') {
                            displaySimple('#board-include', section);
                          }
                          else if (sectionName === 'question') {
                            displaySimple('#question', section);
                          }
                        }
                      }
                      // Display raw data.
                      $('#result').text(JSON.stringify(data, null, 4));
                      $('#result').show();
                    } 
                    else {
                      console.log(data);
                      $('#error').text(data);
                      $('#error').show();
                    }
                  };
              // Remove top and bottom line of pem file
              privateKey = privateKey.split('\n')[1];

              $.ajax({
                type: "POST",
                url: "/get_masks",
                contentType: "application/json",
                data: JSON.stringify({session: sessKey}),
                success: function (data) {
                  unmask(data, privateKey, sessKey, callb);
                },
                error: function() {
                  callb(false, "Error: failed to load masks");
                }
              });

          });
        } else {
          alert("Please upload both files before continuing.");
        }
      });
    </script>
  </div>
</body>
</html>
