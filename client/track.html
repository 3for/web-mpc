<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Trusted Party Live Session Tracker</title>

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"
          integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"
          integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
          integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
          crossorigin="anonymous"></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"
          integrity="sha256-PieqE0QdEDMppwXrTzSZQr6tWFX3W5KkyRVyF1zN3eg=" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/Ladda/1.0.0/ladda.min.js"
          integrity="sha256-/DTavTzjSAI87+voZGCTfhbioWGET1qDJKe76XuWQ5M=" crossorigin="anonymous"></script>

  <script src="/scripts/analyst.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/Ladda/1.0.0/ladda-themeless.min.css"
        integrity="sha256-d7VZTlP9P3ZTCZ3Bkl8aGZ/+Vs4i+bpcOGNfibU7+LU=" crossorigin="anonymous"/>

  <link rel="stylesheet" href="/styles/style.css">

</head>
<body>
<header>
  <div class="container">
    <h1>Trusted Party<br/>
      <small>Live Session Tracker</small>
    </h1>
    <div id="logos">
      <img src="/images/bwwc.png" width="130" alt="BWWC Logo"/>
      <img src="/images/bu.gif" alt="BU Logo"/>
    </div>
  </div>
</header>
<div id="shadow" class="ss-style-multitriangles"></div>
<main id="content" class="container">
</main>
<div class="container">
  <div class="row">
    <section class="card col-md-4">
      <div id="session-login" class="collapse in">
        <h2 class="text-center">Enter session details</h2>
        <hr/>
        <form>
          <div class="form-group">
            <label class="control-label" for="session">Session key</label>
            <input type="text" id="session" class="form-control" placeholder="Session key" pattern="^[a-zA-Z0-9]{26}$"
                   autocomplete="off" required/>
            <span id="session-success" class="success-icon glyphicon glyphicon-ok form-control-feedback hidden"
                  aria-hidden="true"></span>
            <span id="session-fail" class="fail-icon glyphicon glyphicon-remove form-control-feedback hidden"
                  aria-hidden="true"></span>
            <span id="session-fail-help"
                  class="fail-help help-block hidden">Please input the 26-character session key.</span>
            <span id="session-fail-custom-help"
                  class="fail-custom help-block hidden"></span>
          </div>
          <div class="form-group">
            <label class="control-label" for="password">Session password</label>
            <input type="password" id="password" class="form-control" placeholder="Session password"
                   autocomplete="off" required>
            <span id="password-success"
                  class="success-icon glyphicon glyphicon-ok form-control-feedback hidden"
                  aria-hidden="true"></span>
            <span id="password-fail" class="fail-icon glyphicon glyphicon-remove form-control-feedback hidden"
                  aria-hidden="true"></span>
            <span id="password-fail-help"
                  class="fail-help help-block hidden">Please input the session password.</span>
            <span id="password-fail-custom-help"
                  class="fail-custom help-block hidden"></span>
          </div>
          <div class="form-group">
            <button type="submit" id="login" class="btn btn-primary ladda-button btn-lg btn-block">Submit</button>
          </div>
        </form>
      </div>

      <div id="session-panel" class="collapse">
        <h2 class="text-center">Manage your session</h2>
        <p class="text-center">Session status: <span id="session-status"></span></p>
        <form id="session-manage">
          <button type="submit" id="session-start" class="btn btn-success btn-block">Start</button>
          <button type="submit" id="session-pause" class="btn btn-warning btn-block">Pause</button>
          <button type="submit" id="session-stop" class="btn btn-danger btn-block"
                  data-toggle="modal" data-target="#session-stop-modal">Stop
          </button>
        </form>

        <div id="session-stop-modal" class="modal fade" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Close session</h4>
              </div>
              <div class="modal-body">
                <p class="text-danger">Are you sure you wish to permanently close the session? There is NO undo!</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button id="session-close-confirm" type="button" class="btn btn-danger"
                        data-dismiss="modal">Close session
                </button>
              </div>
            </div>
          </div>
        </div>

        <hr/>

        <h2 class="text-center">Add participants</h2>
      </div>
    </section>

    <section class="card col-md-7 col-md-offset-1">
      <h2 class="text-center">Track session</h2>
      <p class="text-center">Fill in your session details on the left to manage your session, add new participants and
        track existing participation.</p>
      <hr/>
    </section>
  </div>

  <div class="hidden">
    <div class="alert alert-success" id="statusID">LOADING...</div>

    <h3>Tracking and Unmasking</h3>
    <div><a id="unmasklink"></a></div>
    <table class="table table-striped" id="table">
      <thead>
      <tr>
        <th>Email</th>
        <th>Posted</th>
      </tr>
      </thead>
      <tbody id="participants">
      </tbody>
    </table>
    <br/>
    <div id="urlsSection">
      <h3>Links for Participants </h3>
      <form class="form-inline" role="form">
        <input autocomplete="off" type="text" id="countID" placeholder="Enter Number of new links needed"
               pattern="^[0-9]{1,5}$" size="5" required>
        <button id="gen_button" type="button" class="btn">
          Generate Links
        </button>
      </form>
      <pre id="urlsID"></pre>

      <div id="oldUrlsSection">
        <h3>Previously Generated Links</h3>
        <pre id="oldUrlsID"></pre>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(function () {
      var session, password;

      $('#session').val(analyst.getParameterByName('session'));

      $('#login').on('click', function (e) {
        e.preventDefault();
        session = $('#session').val();
        password = $('#password').val();

        var la = Ladda.create(document.getElementById('login'));
        la.start();

        analyst.checkStatus(session, password)
          .then(function (status) {
            la.stop();
            changeStatusButtons(status);
            $('#session-login').collapse();
            $('#session-panel').collapse();
          }).catch(function () {
          la.stop();
        });
      });

      $('#session-start').on('click', function (e) {
        e.preventDefault();
        analyst.changeStatus(session, password, analyst.START)
          .then(function () {
            changeStatusButtons(analyst.START);
          });
      });

      $('#session-pause').on('click', function (e) {
        e.preventDefault();
        analyst.changeStatus(session, password, analyst.PAUSE)
          .then(function () {
            changeStatusButtons(analyst.PAUSE);
          });
      });

      $('#session-stop').on('click', function (e) {
        e.preventDefault();
      });

      $('#session-close-confirm').on('click', function (e) {
        e.preventDefault();
        analyst.changeStatus(session, password, analyst.STOP)
          .then(function () {
            changeStatusButtons(analyst.STOP);
          });
      });

      function changeStatusButtons(status) {
        var $start = $('#session-start'),
          $pause = $('#session-pause'),
          $stop = $('#session-stop'),
          $sessionStatus = $('#session-status');
        switch (status) {
          case 'START':
            $start.addClass('hidden');
            $pause.removeClass('hidden');
            $stop.removeClass('hidden');
            $sessionStatus.html('STARTED');
            break;
          case 'PAUSE':
            $start.removeClass('hidden');
            $pause.addClass('hidden');
            $stop.removeClass('hidden');
            $sessionStatus.html('PAUSED');
            break;
          case 'STOP':
            $start.addClass('hidden');
            $pause.addClass('hidden');
            $stop.addClass('hidden');
            $sessionStatus.html('STOPPED');
            break;
        }

      }

      window.genT = function () {
        document.getElementsByClassName('hidden').style.visibility = "visible";

        var session = document.getElementById('session').value;
        var password = document.getElementById('password').value;
        var start = document.getElementById('start').value;
        var pause = document.getElementById('pause').value;
        var stop = document.getElementById('stop').value;
        $('#inputform').remove();

        document.getElementById('unmasklink').innerHTML = "Click here to unmask aggregate data Session " + session;
        document.getElementById('unmasklink').href = "../unmask/index.html?session=" + session;

        checkStatus(session);
        generateTable('table', session, password, 'statusID');

        fetchOldLinks(session, password, "oldUrlsID", "oldUrlsSection");
        document.getElementById("gen_button").onclick = function () {
          var count = document.getElementById("countID").value;
          count = parseInt(count);

          if (isNaN(count)) { // fail gracefully
            alert("Please enter the number of desired links");
            return;
          }

          generateUrls(session, password, 'urlsID', count);
        };

        document.getElementById("start").onclick = function () {
          changeStatus(session, start, password)
        };
        document.getElementById("pause").onclick = function () {
          changeStatus(session, pause, password)
        };
        document.getElementById("stop").onclick = function () {
          document.getElementById('statusbox').value = checkStatus(session);
          document.getElementById('modal_error_msg').innerHTML = "";
          document.getElementById('confirmation').style.visibility = "visible";

          document.getElementById("cancel").onclick = function () {
            document.getElementById('confirmation').style.visibility = "hidden";
          };

          document.getElementById("confirm").onclick = function () {
            var modal_session = document.getElementById('sess_s').value;
            var modal_password = document.getElementById('pass_s').value;
            if (modal_session === session && modal_password === password) {
              document.getElementById('confirmation').style.visibility = "hidden";
              changeStatus(session, stop, password);
            } else {
              document.getElementById('modal_error_msg').innerHTML = "Session and Password do not match!";
            }
          };
        };
      };
    });

  </script>
</div>
</body>
</html>
