<!doctype html>
<html>
<head>
	<title>Trusted Party Data Unmasker</title>

    <script type="text/javascript" src="../shared/jquery-1.18.0.min.js"></script>
    <script type="text/javascript" src="../shared/underscore.js"></script>
    <script type="text/javascript" src="../shared/aggregate.js"></script>
    <script type="text/javascript" src="style/bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="script/spin.min.js"></script>
    <script type="text/javascript" src="script/ladda.min.js"></script>
    <script type="text/javascript" src="script/unmask.js"></script>
    <script src="http://docs.handsontable.com/pro/bower_components/handsontable-pro/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" type="text/css" href="http://docs.handsontable.com/pro/bower_components/handsontable-pro/dist/handsontable.full.min.css">
    <link rel="stylesheet" type="text/css" href="http://handsontable.com/static/css/main.css">
    <link rel="stylesheet" type="text/css" href="style/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="style/ladda-themeless.min.css">
    <style type="text/css">
        .handsontable .ht_clone_top,
        .handsontable .ht_clone_top_left,
        .handsontable .ht_clone_top_left_corner {
          transform: initial !important;
        }
        .handsontable col.rowHeader {
          width: 200px !important;
        }
        .handsontable th:first-child {
          text-align: left;
          white-space: normal;
        }
        .handsontable th {
          font-size:12px;
          white-space: pre-line;
          max-width: 110px;
          vertical-align: middle;
        }
        pre {
            text-align: left;
        }
    </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <table width="100%">
        <tr>
          <td>
            <h1>Trusted Party<br/><small>Aggregate Data Unmasker</small></h1>
          </td>
          <td align="right">
            <img src="../shared/seal.png" width="130px"/>&nbsp;&nbsp;
            <img src="../shared/logo.png" width="130px"/>&nbsp;&nbsp;&nbsp;
            <img src="../shared/bu.png" width="110px"/>
          </td>
        </tr>
      </table>
    </div>

    <h4>Input Session Key</h4>
    <input type=text id="sessKey" placeholder="Session Key"/>

    <h4>Upload Private Key  <small>(Note this does not upload the key to the network)</small></h4>
    <input type=file id="maskKey"/>

    <br/>
    <br/>

    <button id="unmask" class="btn btn-primary ladda-button" data-style="zoom-out">
      <span class="ladda-label">Unmask Data</span>
    </button>

    <br/><br/>
    <div id="friendly"></div>
    <br/>
    <pre id="result"></pre>
    <script type="text/javascript">
      // This is the handsontable object which will be defined
      // during the unmasking process.
      var hot;
      $('#unmask').on('click', function() {
        var maskKey = $('#maskKey').get(0),
            sessKey = $('#sessKey').val(),
            la = Ladda.create(this),
            keyReader = new FileReader();

        if (maskKey.files.length) {
          la.start();
          keyReader.readAsText(maskKey.files[0]);
          $(keyReader).on('load', function(e) {
            var privateKey = e.target.result,
                callb =
                  function (success, data) {
                    la.stop();
                    if (success) {
                      var sections = unflatten(data),
                          mainTable = sections["main"];
                      $.ajax({
                        type: "GET",
                        url: "../shared/templates/main.json",
                        dataType: "json",
                        success: function (tableConfig) {
                          // Check if we have created the table already. This prevents
                          // new copies of the table from getting appended to the end
                          // of the containing div.
                          if (hot == null) {
                            hot = makeTable("#friendly", tableConfig);
                          }
                          // TODO: double-check this
                          var rowIdxLookup = {};
                          tableConfig.rowKeys.forEach(function (key, idx) {
                            return rowIdxLookup[key] = idx;
                          });
                          var colIdxLookup = {};
                          tableConfig.colKeys.forEach(function (key, idx) {
                            return colIdxLookup[key] = idx;
                          });
                          console.log(rowIdxLookup);
                          console.log(colIdxLookup);

                          // Populate table with loaded values.
                          populateTable(hot, mainTable, tableConfig.numRows, 
                            tableConfig.numCols, rowIdxLookup, colIdxLookup);
                          // Display raw data. 
                          // TODO: check!!
                          $('#result').html(JSON.stringify(data, null, 4));
                        },
                        error: function () {
                          console.log('Error while retrieving main template.');
                          $('#result').html('Error while retrieving main template.');
                        } 
                      }); 
                    } 
                    else {
                      console.log(data);
                      // TODO: this is a terrible idea
                      $('#result').html(data);
                    }
                  };
              // Remove top and bottom line of pem file
              privateKey = privateKey.split('\n')[1];

              $.ajax({
                type: "POST",
                url: "/get_masks",
                contentType: "application/json",
                data: JSON.stringify({session: parseInt(sessKey)}),
                success: function (data) {
                  unmask(data, privateKey, sessKey, callb);
                },
                error: function() {
                  callb(false, "failed to load masks");
                }
              });

          });
        } else {
          alert("Please upload both files before continuing.");
        }
      });
    </script>
  </div>
</body>
</html>
